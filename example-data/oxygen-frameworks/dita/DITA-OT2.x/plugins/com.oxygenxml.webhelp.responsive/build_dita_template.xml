<?xml version="1.0" encoding="UTF-8"?>
<!--
    
Oxygen WebHelp Plugin
Copyright (c) 1998-2017 Syncro Soft SRL, Romania.  All rights reserved.

-->

<!-- Extend the toolkit's XHTML processing to generate WebHelp output. -->
<project name="webhelp.responsive.integrator" default="dita2webhelp-responsive" basedir="."
  xmlns:dita="http://dita-ot.sourceforge.net">
  
  <!-- 
    Task definition for ant-contrib library.
  -->
  <taskdef resource="net/sf/antcontrib/antlib.xml">
    <classpath>
      <pathelement location="${webhelp.responsive.dir}/lib/ant-contrib-1.0b3.jar"/>
    </classpath>
  </taskdef>
  
  <!--
    Main target to create WebHelp Responsive output.
  -->
  <target name="dita2webhelp-responsive" 
    dita:depends="
      whr-init, 
      preprocess,
      
      {com.oxygenxml.responsive.internal.target.dependencies.xhtml.init},
     
      whr-detect-lang,
      whr-collect-indexterms,
      whr-create-props-file,
      whr-toc-xml,
      whr-nav-links,
      whr-context-help-map,
      whr-sitemap,
      whr-copy-resources,
      copy-css,      
      
      {com.oxygenxml.responsive.internal.target.dependencies.topics.html},      
      
      whr-create-topic-pages,      
      
      {com.oxygenxml.responsive.internal.target.dependencies.outer.topics},
      
      whr-create-main-files,
      whr-copy-feedback-localization,
      whr-search-index"
      
    dita:extension="depends org.dita.dost.platform.InsertDependsAction">    
  </target>
  
  <!-- Targets used to inialize the WebHelp Responsive build -->
  <target name="whr-init" 
    depends="build-init, whr-init-classpath, whr-init-custom-template, whr-init-properties, whr-init-collection-type-prop, whr-check-license, whr-check-feedback-params"/>

  <target name="whr-init-classpath">
    <!-- Directory of the WebHelp plugin. -->
    <property name="webhelp.responsive.dir" value="${dita.plugin.com.oxygenxml.webhelp.responsive.dir}"/>  
    
    <!-- Directory with WebHelp library files -->
    <property name="webhelp.responsive.lib.dir" value="${webhelp.responsive.dir}/lib"/>
    
    <!-- Plugin classpath. -->
    <path id="wh_classpath">      
      <fileset dir="${webhelp.responsive.lib.dir}">
        <include name="*.jar"/>
      </fileset>
    </path>
  </target>
  
  <!--
    Load the WebHelp Responsive custom template.
  -->
  <target name="whr-init-custom-template" if="webhelp.publishing.template">     
    <!-- Task used to load properties for a custom template. -->
    <taskdef name="templatetask" 
      classname="com.oxygenxml.publishing.template.PublisingTemplateTask" 
      classpathref="wh_classpath"/>
        
    <echo>Using custom WebHelp Responsive Template package: ${webhelp.publishing.template}</echo>
    
    <condition property="template.descriptor.name" value="${webhelp.publishing.template.descriptor}" else="">
      <isset property="webhelp.publishing.template.descriptor"/>
    </condition>
    
    <templatetask 
      outputDir="${output.dir}"
      tempDir="${dita.temp.dir}"
      templateDescriptor="${template.descriptor.name}"
      templateRootPath="${webhelp.publishing.template}"/>    
  </target>

  <!--
    Initialize the WebHelp Responsive properties.
  -->
  <target name="whr-init-properties">     
    <!--
      =======================
        DITA-OT Properties
      =======================
    -->
    
    <!-- We load the ditaotversion param from this DITA-OT configuration properties file.-->
    <loadproperties srcfile="${dita.dir}/lib/configuration.properties"/>
    
    <!-- The extension for the output files. It is expanded by DITA-OT to ".${args.outext}" -->
    <property name="out.ext" value=".html"/>
    
    <!-- 
      EXM-39143 / WH-1370: Setting this to true ensures that unique output files are created for each instance of a 
      resource when a map contains multiple references to a single topic. 
    -->
    <property name="force-unique" value="true"/>
    
    <!-- Default language for translated strings in HTML pages. Should be set by caller process. -->
    <property name="args.default.language" value="en-US"/>
    
    <!--
      =============================
        WebHelp general properties
      =============================
    -->    
    <!-- Directory with WebHelp library files -->
    <property name="webhelp.responsive.lib.dir" value="${webhelp.responsive.dir}/lib" />

    <!-- The file where all build properties are serialized. This file is used to read the properties into the XSLT stylesheets. -->
    <property name="webhelp.responsive.parameters.file" location="${dita.temp.dir}/props.xml"/>
    
    <property name="webhelp.reload.stylesheet" value="false"/>    
    
    <!-- Test if custom resources directory exists -->
    <available file="${webhelp.custom.resources}" property="webhelp.custom.resources.present" />
    
    <!-- WebHelp version & build number. -->
    <property name="webhelp.version" value="@@WEBHELP_VERSION@@" />
    <property name="webhelp.build.number" value="@@WEBHELP_BUILD_NUMBER@@" />
    
    <!-- Store the current time stamp in the given property. -->	
    <tstamp>
      <format property="whr.gen.time" pattern="yyyyMMddhhmmss" />
    </tstamp>
    
    <!-- Condition to enable the Feedback feature. --> 
    <condition property="webhelp.feedback.enabled">
      <and>
        <isset property="webhelp.product.id" />
        <isset property="webhelp.product.version" />
      </and>
    </condition>
    
    <!--
      ==========================================
        WebHelp Responsive template properties
      ==========================================
    -->    
    <!-- WebHelp Responsive template related properties. --> 
    <property name="webhelp.responsive.templates.base.dir" location="${webhelp.responsive.dir}/templates/dita" />
    <property name="webhelp.responsive.template.name" value="bootstrap" />
    <property name="webhelp.responsive.variant.name" value="tiles" />
    <property name="webhelp.responsive.skin.name" value="oxygen" />
    
    <property name="webhelp.responsive.template.dir" location="${webhelp.responsive.templates.base.dir}/${webhelp.responsive.template.name}" />
    <property name="webhelp.responsive.variant.dir" location="${webhelp.responsive.template.dir}/variants/${webhelp.responsive.variant.name}" />
    <property name="webhelp.responsive.skin.dir" location="${webhelp.responsive.variant.dir}/${webhelp.responsive.skin.name}" />

    <!-- The WebHelp HTML template files. -->
    <property name="webhelp.template.search.file" value="${webhelp.responsive.template.dir}/wt_search.html" />
    <property name="webhelp.template.index.file" value="${webhelp.responsive.template.dir}/wt_index.html"/>
    <property name="webhelp.template.index.terms.file" value="${webhelp.responsive.template.dir}/wt_terms.html"/>
    <property name="webhelp.template.file.path" value="${webhelp.responsive.template.dir}/wt_topic.html"/>
    
    <!-- The WebHelp template components properties. -->
    <property name="webhelp.side.toc.links" value="chapter"></property>
    <property name="webhelp.side.toc.tooltip.position" value="left"/>
  	<property name="webhelp.top.menu.depth" value="3"/>

    <!-- Google search parameters: convert the file paths to URLs -->
    <if>
      <isset property="webhelp.google.search.script"/>
      <then>
        <makeurl property="webhelp.google.search.script.url" file="${webhelp.google.search.script}"/>
      </then>
    </if>
    <if>
      <isset property="webhelp.google.search.results"/>
      <then>
        <makeurl property="webhelp.google.search.results.url"
          file="${webhelp.google.search.results}"/>
      </then>
    </if>
    
    <!-- Navigation links -->
    <property name="webhelp.top.menu.temp.file" value="${dita.temp.dir}/webhelp-top-menu.xml"/>
    <makeurl property="webhelp.top.menu.temp.file.url" file="${webhelp.top.menu.temp.file}" validate="false"/>

    <!--
      =============================
        WebHelp search properties
      =============================
    -->
    <!-- WebHelp search related properties -->
    <property name="webhelp.search.ranking" value="true"/>
    
   <!-- 
		Property used to disable search autocomplete 
	-->
    <property name="webhelp.enable.search.autocomplete" value="true" />
    
    <!-- 
		Property used to disable search pagination
	-->
    <property name="webhelp.search.enable.pagination" value="true" />
    
    <!-- Specify the prefix to be used when accessing environment variables. -->
    <property environment="env" />
    
    <property 
      name="webhelp.responsive.xsl.extensions.xml.catalog.file.path" 
      value="${dita.plugin.com.oxygenxml.webhelp.responsive.dir}/xsl/template_catalog.xml"></property>
    
    <xmlcatalog id="xsl_extensions_catalog">
      <catalogpath path="${webhelp.responsive.xsl.extensions.xml.catalog.file.path}"/>
    </xmlcatalog>
    
    <!--
      WH-200 - webhelp.default.collection.type.sequence parameter is use to always generate Next and Previous buttons.
    -->
    <condition property="webhelp.default.collection.type.sequence.prop">
      <istrue value="${webhelp.default.collection.type.sequence}"/>
    </condition>
     
   <!-- <!-\- 
      The file where properties available for preprocess steps are serialized. 
      This file is used to read the properties into the XSLT stylesheets. 
    -\->
    <property name="preprocess.props.file" location="${dita.temp.dir}/preprocess_props.xml"/>
    <echoproperties 
      destfile="${preprocess.props.file}" 
      format="xml" 
      prefix="webhelp.default.collection.type.sequence.prop"/>   --> 
  </target>
  
  <!--
      WH-200 - 'webhelp.default.collection.type.sequence.prop' system property is used from XSLT to always generate Next and Previous buttons.
  -->
  <target name="whr-init-collection-type-prop" if="webhelp.default.collection.type.sequence.prop">
    <script language="javascript">
      <![CDATA[
                java.lang.System.setProperty("webhelp.default.collection.type.sequence.prop", "yes");
            ]]>
    </script>   
  </target>
  
  
  <!--
		Check license for WebHelp Responsive.
	-->
  <target name="whr-check-license" unless="${env.SAXON_EE_LICENSED_ENV}">
    <echo>Using directory ${webhelp.responsive.lib.dir} </echo>
    <available classname="ro.sync.licensemanager.WebhelpLicenseChecker" 
      property="WebhelpLicenseChecker.present">
      <classpath>
        <fileset dir="${webhelp.responsive.lib.dir}">
          <include name="*.jar" />
        </fileset>
      </classpath>
    </available>
    <fail unless="WebhelpLicenseChecker.present" 
      message="The WebHelp Plugin does not contain all jar files. Please contact support@oxygenxml.com for more details."/>
    <java classname="ro.sync.licensemanager.WebhelpLicenseChecker" 
      failonerror="true"
      fork="true" logError="true">
      <arg value="${webhelp.responsive.dir}" />
      <classpath>
        <fileset dir="${webhelp.responsive.lib.dir}">
          <include name="*.jar" />
        </fileset>
      </classpath>
    </java>
  </target>
    
  <!--
    Test if feedback parameters(product ID and version) are valid.
  -->
  <target name="whr-check-feedback-params" if="webhelp.feedback.enabled">    
    <!-- Test if  -->
    <macrodef name="checkSpecialCharacter">
      <attribute name="char" />
      <sequential>
        <fail message="Special character '@{char}' must not be used in the product ID: ${webhelp.product.id}">
          <condition>
            <contains string="${webhelp.product.id}" substring="@{char}" />
          </condition>
        </fail>
        <fail message="Special character '@{char}' must not be used in the product version: ${webhelp.product.version}">
          <condition>
            <contains string="${webhelp.product.version}" substring="@{char}" />
          </condition>
        </fail>
      </sequential>
    </macrodef>
    
    <!-- Check if special characters are used: &lt; &gt; / \ &apos; ( ) { } = ; * % + &amp; -->
    <checkSpecialCharacter char="&lt;" />
    <checkSpecialCharacter char="&gt;" />
    <checkSpecialCharacter char="/" />
    <checkSpecialCharacter char="\" />
    <checkSpecialCharacter char="&apos;" />
    <checkSpecialCharacter char="(" />
    <checkSpecialCharacter char=")" />
    <checkSpecialCharacter char="{" />
    <checkSpecialCharacter char="}" />
    <checkSpecialCharacter char="=" />
    <checkSpecialCharacter char=";" />
    <checkSpecialCharacter char="*" />
    <checkSpecialCharacter char="%" />
    <checkSpecialCharacter char="+" />
    <checkSpecialCharacter char="&amp;" />
  </target>  
  
  <!--
		Copy favicon in the output directory.
	-->
  <target name="whr-copy-favicon">
    <!-- Test if favicon resource is available -->
    <available file="${webhelp.favicon}" property="webhelp.favicon.present" type="file"/>
    <if>
      <isset property="webhelp.favicon.present" />
      <then>
        <copy file="${webhelp.favicon}" todir="${output.dir}" overwrite="true" />
        <basename file="${webhelp.favicon}" property="webhelp.favicon.relpath" />
      </then>
      <else>
        <condition property="webhelp.favicon.relpath" value="${webhelp.favicon}">
          <isset property="webhelp.favicon" />
        </condition>
      </else>
    </if>
    
  </target>

  <target name="whr-copy-custom-resources" if="${webhelp.custom.resources.present}">
    <!-- All custom resources set with param webhelp.custom.resources will be copied in output directory. -->
    <copy todir="${output.dir}" overwrite="true" encoding="UTF-8" failonerror="true">
      <fileset dir="${webhelp.custom.resources}">
        <include name="**/*" />
      </fileset>
    </copy>
  </target>
  
  <!-- 
		Copy logo image to the output folder 
	-->
  <target name="whr-copy-logo-image">
    <available type="file" file="${webhelp.logo.image}" property="webhelp.logo.image.file" />
    <if>
      <isset property="webhelp.logo.image.file" />
      <then>
        <copy file="${webhelp.logo.image}" todir="${output.dir}" overwrite="true" />
        <basename file="${webhelp.logo.image}" property="webhelp.logo.image.output" />
        <property 
          name="webhelp.logo.image.output.file" 
          value="${output.dir}/${webhelp.logo.image.output}"/>
      </then>
      <else>
        <condition property="webhelp.logo.image.output" value="${webhelp.logo.image}">
          <isset property="webhelp.logo.image" />
        </condition>
      </else>
    </if>
  </target>
  
  <target 
    name="whr-create-topic-pages" 
    depends="whr-process-reviews, whr-dita-inner-topics" unless="noTopic"/>
  
  <!-- Create the JavaScript files with the search database. -->
  <target name="whr-search-index" depends="whr-search-index-preprocess">
    <!-- Extract search JS from jar and copy them to the 'oxygen-webhelp/search' folder -->
    
    <copy todir="${output.dir}/oxygen-webhelp/search/">
      <resources>
        <javaresource name="searchEngineJS/nwSearchFnt.LICENSE.txt" classpathref="wh_classpath" />
        <javaresource name="searchEngineJS/nwSearchFnt.js"  classpathref="wh_classpath"/>
      </resources>
      <flattenmapper/>
    </copy>
    <copy todir="${output.dir}/oxygen-webhelp/search/stemmers/">
      <resources>
        <javaresource name="searchEngineJS/stemmers/en_stemmer.js"  classpathref="wh_classpath"/>
        <javaresource name="searchEngineJS/stemmers/fr_stemmer.js"  classpathref="wh_classpath"/>
        <javaresource name="searchEngineJS/stemmers/index.html"  classpathref="wh_classpath"/>
        <javaresource name="searchEngineJS/stemmers/de_stemmer.js"  classpathref="wh_classpath"/>
      </resources>
      <flattenmapper/>
    </copy>
    
    <!-- WebHelp Search Options -->
    <condition property="webhelp.search.ranking.boolean" else="false">
      <istrue value="${webhelp.search.ranking}"/>
    </condition>
    <condition property="webhelp.enable.search.autocomplete.boolean" else="false">
      <istrue value="${webhelp.enable.search.autocomplete}"/>
    </condition>
    <condition property="webhelp.search.enable.pagination.boolean" else="false" value="true">
      <istrue value="${webhelp.search.enable.pagination}"/>
    </condition>
    
    <condition property="webhelp.search.page.numberOfItems.number" else="10" value="${webhelp.search.page.numberOfItems}">
      <isset property="webhelp.search.page.numberOfItems"/>
    </condition>
    
    <copy file="${webhelp.responsive.dir}/oxygen-webhelp/search/searchOptions_template.js" tofile="${output.dir}/oxygen-webhelp/search/searchOptions.js" overwrite="true">
      <filterset begintoken="@@" endtoken="@@"> 
        <filter token="SEARCH_RANKING" value="${webhelp.search.ranking.boolean}"/>
        <filter token="ENABLE_AUTOCOMPLETE" value="${webhelp.enable.search.autocomplete.boolean}"/>
        <filter token="ENABLE_SEARCH_PAGINATION" value="${webhelp.search.enable.pagination.boolean}"/>
        <filter token="SEARCH_NUMBER_OF_ITEMS" value="${webhelp.search.page.numberOfItems.number}"/>
      </filterset>
    </copy>
    
    <taskdef name="indexertask" classname="ro.sync.exml.indexer.IndexerTask" classpathref="wh_classpath"/>
    
    <!-- Remove the leading "." from the output extension -->
    <propertyregex property="noDotExt" input="${out.ext}"
      regexp="^\.(.*)" replace="\1"
      defaultValue="${out.ext}" casesensitive="false" />
    
    <echo>Indexing html files in ${output.dir}, indexer language is: ${webhelp.language}</echo>
    <indexertask 
      outputDir="${output.dir}/oxygen-webhelp/search" 
      propsDir="${webhelp.responsive.dir}/indexer"
      indexerLanguage="${webhelp.language}" 
      htmlExtension="${noDotExt}"
      stem="${use.stemming}"
      enableAutocomplete="${webhelp.enable.search.autocomplete}"
      userDictionary="${webhelp.search.japanese.dictionary}"
      doNotIndex="div.ignore,div.navfooter,div.footer,div.navheader,div.wh_top_menu,div.wh_breadcrumb,div.wh_side_toc,
      div.wh_tools,div.wh_publication_title,div.wh_indexterms_link,div.wh_copyright_information,nav.wh_footer,nav.related-links,
      span.navheader, span.navparent, div.navfooter,span.topic_breadcrumb_links">
      
      
      <fileset dir="${output.dir}">
        <patternset>
          <!-- Index only html files -->
          <include name="**/*.${noDotExt}" />
          <!-- Exclude html files should not be indexed -->
          <exclude name="index.${noDotExt}" />
          <exclude name="toc.${noDotExt}" />
          <exclude name="index_frames.${noDotExt}" />
          <exclude name="search.${noDotExt}" />
          <exclude name="indexTerms.${noDotExt}" />
          <!-- Exclude the resources dir -->
          <exclude name="oxygen-webhelp/" />
        </patternset>
        <patternset>
          <excludesfile name="${webhelp.search.custom.excludes.file}" if="webhelp.search.custom.excludes.file" />
          <!-- File containig name exclusion patterns generated from the @search="no" attribute from the DITA Map. -->
          <excludesfile name="${search.excludes.file}" if="${search.excludes.file.exists}" />
        </patternset>
      </fileset>
    </indexertask>
  </target>
  
  
  
  <!--
    !!! COPY marker !!!
  -->
  
  <!-- 
             The JavaScript, CSS image and localization files are copied to output folder. 
             They are referenced in the output HTML pages.
      -->
  <target name="whr-copy-common-resources">
    <propertyregex property="corrected.output.dir" input="${output.dir}" regexp="\\" replace="/"
      defaultvalue="${output.dir}" global="true"/>
    
    <copy todir="${output.dir}/oxygen-webhelp" overwrite="true" encoding="ISO-8859-1">
      <fileset dir="${webhelp.responsive.dir}/oxygen-webhelp">
        <include name="**/*" />
        <exclude name="**/.svn" />
        <exclude name="resources/*.html" unless="webhelp.feedback.enabled" />
        <exclude name="resources/js/init.js" unless="webhelp.feedback.enabled" />
        <exclude name="resources/js/comments*.js" unless="webhelp.feedback.enabled" />
        <exclude name="feedback.xml" />
        <exclude name="resources/img/**" />
        <exclude name="resources/skins/**" />
        <exclude name="resources/include/**" />
        <exclude name="resources/localization/**" />
        <exclude name="resources/php/**" />
        <exclude name="feedback/**" />
        <exclude name="search/searchOptions_template.js"/>
      </fileset>
      <filterset begintoken="@" endtoken="@">
        <filter token="PRODUCT_ID" value="${webhelp.product.id}" />
        <filter token="PRODUCT_VERSION" value="${webhelp.product.version}" />
        <filter token="FOLDER_OUTPUT_PATH" value="${corrected.output.dir}" />
        <filter token="WEBHELP_PAGE_DIRECTION" value="${webhelp.page.direction}" />
      </filterset>
    </copy>
    <copy todir="${output.dir}/oxygen-webhelp/resources/img" overwrite="true">
      <fileset dir="${webhelp.responsive.dir}/oxygen-webhelp/resources/img">
        <include name="**/*" />
        <exclude name="**/.svn" />
      </fileset>
    </copy>    
    <copy file="${webhelp.responsive.dir}/license-3rd-party.txt" todir="${output.dir}" />
  </target>
  
  
  <target name="whr-copy-feedback-resources" if="${webhelp.feedback.enabled}">
    <copy todir="${output.dir}/oxygen-webhelp" overwrite="true" encoding="UTF-8">
      <fileset dir="${webhelp.responsive.dir}/oxygen-webhelp">
        <include name="feedback/**/*" if="webhelp.feedback.enabled" />
        <exclude name="feedback.xml" />
        <exclude name="feedback/resources/img/*" />
        <exclude name="feedback/install/img/*" />
      	<exclude name="feedback/resources/bootstrap/fonts/*"/>
      </fileset>
      <filterset begintoken="@" endtoken="@">
        <filter token="PRODUCT_ID" value="${webhelp.product.id}" />
        <filter token="PRODUCT_VERSION" value="${webhelp.product.version}" />
        <filter token="FOLDER_OUTPUT_PATH" value="${corrected.output.dir}" />
        <filter token="WEBHELP_PAGE_DIRECTION" value="${webhelp.page.direction}" />
        <filter token="LANGUAGE" value="${webhelp.language}" />
      </filterset>
    </copy>
    <copy todir="${output.dir}/oxygen-webhelp" overwrite="true">
      <fileset dir="${webhelp.responsive.dir}/oxygen-webhelp">
        <include name="feedback/install/img/*" if="webhelp.feedback.enabled" />
        <include name="feedback/resources/img/*" if="webhelp.feedback.enabled" />
      	<include name="feedback/resources/bootstrap/fonts/*" if="webhelp-feedback-enabled" />
      </fileset>
    </copy>
  </target>
  
  <target name="whr-copy-feedback-localization" if="${webhelp.feedback.enabled}">
    <copy todir="${output.dir}/oxygen-webhelp/feedback/resources" overwrite="true">
      <fileset dir="${output.dir}/oxygen-webhelp/resources">
        <include name="localization/**/*"/>
      </fileset>
    </copy>
  </target>

  <!--
    Write properties to an XML file so they can be read from XSLT processing steps. 
  -->
  <target name="whr-create-props-file">
    <property file="${webhelp.responsive.variant.dir}/params.properties"/>    
    <touch file="${webhelp.responsive.parameters.file}" mkdirs="true"/>
    <echoproperties destfile="${webhelp.responsive.parameters.file}" format="xml"/>
    
    <!-- URL to the XML file that lists all the available properties -->
    <makeurl property="webhelp.responsive.parameters.file.url" file="${webhelp.responsive.parameters.file}"/>
  </target>
  

  <!--
    Detect documentation language by looking into DITAMAP file. 
    If not detected use the value of 'args.default.language' property.
  -->
  <target name="whr-detect-lang">
    <property name="inputMap" value="${dita.temp.dir}/${user.input.file}"/>

    <taskdef name="detect-lang" classname="com.suite.sol.ditaot.DetectLang">
      <classpath path="${dita.dir}/plugins/org.dita.pdf2/lib/fo.jar"/>
    </taskdef>

    <!-- Set document.locale from xml:lang -->
    <!-- The map takes precedence, followed by the first topic -->
    <detect-lang documentPath="${inputMap}"/>
    
    <!-- Set webhelp.language property -->
    <if>
      <isset property="document.locale"/>
      <then>
        <!-- Use use propertyregex from antcontrib -->
        <propertyregex property="webhelp.language" input="${document.locale}" regexp="(..)"
          select="\1" defaultvalue="en" override="true"/>
      </then>
      <else>
        <if>
          <isset property="args.default.language"/>
          <then>
            <!-- Use use propertyregex from antcontrib -->
            <propertyregex property="webhelp.language" input="${args.default.language}"
              regexp="(..)" select="\1" defaultvalue="en" override="true"/>
          </then>
        </if>
      </else>
    </if>
    
    <!--
      Set the 'webhelp.page.direction' property depending detected language.
    -->    
    <condition property="webhelp.page.direction" value="rtl" else="ltr">
      <or>
        <equals arg1="ar" arg2="${webhelp.language}"/>
        <equals arg1="ar-eg" arg2="${webhelp.language}"/>
        <equals arg1="he" arg2="${webhelp.language}"/>
        <equals arg1="he-il" arg2="${webhelp.language}"/>
        <equals arg1="ur" arg2="${webhelp.language}"/>
        <equals arg1="ur-pk" arg2="${webhelp.language}"/>
      </or>
    </condition>
    
    <echo>Indexer language=${webhelp.language}</echo>
  </target>

  
  <!--
    Collect index terms from DITA topics and write they in ${output.dir}/index.xml. 
    
    The 'index.xml' file will be used to generate the 'indexTerms.html' file. 
  -->
  <target name="whr-collect-indexterms" description="Build list of index terms" unless="noTopic">
    <property name="args.extract.indexterms.xsl"
      value="${webhelp.responsive.dir}/xsl/indexterms/extractIndexterms.xsl"/>
    <makeurl property="dita.temp.dir.url" file="${dita.temp.dir}"/>
    <xslt processor="trax" basedir="${dita.temp.dir}" destdir="${dita.temp.dir}"
      includesfile="${dita.temp.dir}/${fullditatopicfile}"
      excludesfile="${dita.temp.dir}/${resourceonlyfile}" style="${args.extract.indexterms.xsl}"
      classpathref="dost.class.path" reloadstylesheet="${webhelp.reload.stylesheet}">
      <factory name="net.sf.saxon.TransformerFactoryImpl"/>
      <param name="TEMPFOLDER" expression="${dita.temp.dir.url}"/>
      <param name="OUT_EXT" expression="${out.ext}"/>
      <mapper type="regexp" from="^(.*?)$$" to="\1.indexterms"/>
      <sysproperty key="DOT_VERSION" value="${otversion}"/>
      <xmlcatalog>
        <xmlcatalog refid="dita.catalog"/>
        <xmlcatalog refid="xsl_extensions_catalog"/>
      </xmlcatalog>
    </xslt>
    
    <!-- The properties file where indexterms related properties will be serialized by the xslt transformation below --> 
    <property name="indexterms.properties.file" value="${output.dir}/indexterms.properties"/>
    <touch file="${indexterms.properties.file}"/>
    <makeurl property="indexterms.properties.url" file="${indexterms.properties.file}"/>
    
    <xslt processor="trax" in="${dita.temp.dir}/${user.input.file}" out="${output.dir}/index.xml"
      style="${webhelp.responsive.dir}/xsl/indexterms/collectIndexterms.xsl" classpathref="dost.class.path"
      reloadstylesheet="${webhelp.reload.stylesheet}">
      <factory name="net.sf.saxon.TransformerFactoryImpl"/>
      <param name="TEMPFOLDER" expression="${dita.temp.dir}"/>
      <param name="FILELIST" expression="${dita.temp.dir}/${fullditatopicfile}"/>
      <param name="FILELIST_TO_EXCLUDE" expression="${dita.temp.dir}/${resourceonlyfile}"/>
      <param name="FILELIST_ENCODING" expression="${file.encoding}"/>
      <param name="INDEXTERMS_PROPERTIES_URL" expression="${indexterms.properties.url}"/>
      <param name="WEBHELP_PARAMETERS_URL" expression="${webhelp.responsive.parameters.file.url}"/>
      <sysproperty key="DOT_VERSION" value="${otversion}"/>
      
      <xmlcatalog>
        <xmlcatalog refid="xsl_extensions_catalog"/>
        <xmlcatalog refid="dita.catalog"/>
      </xmlcatalog>
    </xslt>
    
    <!-- Load the indexterms related properties -->
    <property file="${indexterms.properties.file}"/>
  </target>


  <!--
		Converts the oXygen review PIs (change tracking, comments, etc..) into elements, and 
		structures the replies into the parent comments. 
	-->
  <target name="whr-process-reviews" if="${webhelp.show.changes.and.comments}" unless="noTopic">

    <echo>Transforming Oxygen PIs into elements.</echo>

    <xslt processor="trax" basedir="${dita.temp.dir}" destdir="${dita.temp.dir}.1"
      includesfile="${dita.temp.dir}/${fullditatopicfile}"
      style="${dita.plugin.com.oxygenxml.webhelp.responsive.dir}/xsl/review/review-pis-to-elements.xsl"
      force="yes" failOnError="yes" failOnTransformationError="yes"
      reloadstylesheet="${webhelp.reload.stylesheet}">

      <factory name="net.sf.saxon.TransformerFactoryImpl"/>

      <excludesfile name="${dita.temp.dir}/${resourceonlyfile}" if="resourceonlyfile"/>
      <includesfile name="${dita.temp.dir}/${chunkedtopicfile}" if="chunkedtopicfile"/>
      <param name="show.changes.and.comments" expression="${webhelp.show.changes.and.comments}"/>

      <xmlcatalog> <xmlcatalog refid="xsl_extensions_catalog"/>
      <xmlcatalog refid="dita.catalog"/></xmlcatalog>
      <mapper type="identity"/>
    </xslt>


    <echo>Grouping comments into threads.</echo>

    <xslt processor="trax" basedir="${dita.temp.dir}.1" destdir="${dita.temp.dir}"
      includesfile="${dita.temp.dir}/${fullditatopicfile}"
      style="${dita.plugin.com.oxygenxml.webhelp.responsive.dir}/xsl/review/review-group-replies.xsl"
      force="yes" failOnError="yes" failOnTransformationError="yes"
      reloadstylesheet="${webhelp.reload.stylesheet}">

      <factory name="net.sf.saxon.TransformerFactoryImpl"/>
      <excludesfile name="${dita.temp.dir}/${resourceonlyfile}" if="resourceonlyfile"/>
      <includesfile name="${dita.temp.dir}/${chunkedtopicfile}" if="chunkedtopicfile"/>
      <param name="show.changes.and.comments" expression="${webhelp.show.changes.and.comments}"/>

      <xmlcatalog><xmlcatalog refid="xsl_extensions_catalog"/>
      <xmlcatalog refid="dita.catalog"/></xmlcatalog>
      <mapper type="identity"/>
    </xslt>
  </target>
  
  <!-- 
    Create the index.html, search.html and indexTerms.html files. 
  -->
  <target 
    name="whr-create-main-files" 
    depends="whr-create-main-page, whr-create-search-page, whr-create-indexterms-page, whr-create-localization-files"/>

  <!-- 
    Create the index.html. 
  -->
  <target 
    name="whr-create-main-page">

    <property name="args.whr.create.main.page.xsl" value="${webhelp.responsive.dir}/xsl/mainFiles/createMainPage.xsl"/>

    <xslt processor="trax" in="${webhelp.template.index.file}" out="${output.dir}/index${out.ext}"
      style="${args.whr.create.main.page.xsl}" force="yes" classpathref="dost.class.path">
      <factory name="net.sf.saxon.TransformerFactoryImpl"/>
      <param name="TOC_XML_FILEPATH" expression="${output.dir}/toc.xml"/>
      <param name="XHTML_FOLDER" expression="${output.dir}"/>
      <param name="OUTPUTDIR" expression="${output.dir}"/>
      <param name="BASEDIR" expression="${webhelp.responsive.dir}"/>
      <param name="OUTEXT" expression="${out.ext}" if="out.ext"/>
      <param name="DEFAULTLANG" expression="${args.default.language}" if="args.default.language"/>
      <param name="CSS" expression="${args.css.file}" if="args.css.file"/>
      <param name="CSSPATH" expression="${user.csspath}" if="user.csspath"/>
      <param name="WEBHELP_LOGO_IMAGE" expression="${webhelp.logo.image.output}"
        if="webhelp.logo.image.output"/>
      <param name="WEBHELP_LOGO_IMAGE_TARGET_URL" expression="${webhelp.logo.image.target.url}"
        if="webhelp.logo.image.target.url"/>
      <param name="WEBHELP_FAVICON" expression="${webhelp.favicon.relpath}" if="webhelp.favicon.relpath"/>
      <param name="WEBHELP_SEARCH_RANKING" expression="${webhelp.search.ranking}"
        if="webhelp.search.ranking"/>
      <param name="WEBHELP_SEARCH_SCRIPT" expression="${webhelp.google.search.script.url}"
        if="webhelp.google.search.script.url"/>
      <param name="WEBHELP_SEARCH_RESULT" expression="${webhelp.google.search.results.url}"
        if="webhelp.google.search.results.url"/>
      <param name="WEBHELP_VERSION" expression="${webhelp.version}" if="webhelp.version"/>
      <param name="WEBHELP_BUILD_NUMBER" expression="${webhelp.build.number}"
        if="webhelp.build.number"/>
      <param name="WEBHELP_UNIQUE_ID" expression="${whr.gen.time}"/>      
      <param name="WEBHELP_TRIAL_LICENSE" expression="${webhelp.trial.license}"
        if="webhelp.trial.license"/>

      <param name="WEBHELP_DITAMAP_URL" expression="${org.dita-ot.html.map.url}"/>

      <param name="WEBHELP_PARAMETERS_URL" expression="${webhelp.responsive.parameters.file.url}"/>
      <param name="show.changes.and.comments" expression="${webhelp.show.changes.and.comments}"/>
      
      <!-- Navigation links params -->
      <param name="WEBHELP_TOP_MENU_TEMP_FILE_URL" expression="${webhelp.top.menu.temp.file.url}"/>

      <!-- 
        Extension point to pass parameters to the XSLT transformation that creates the main HTML page.
      -->
      <dita:extension id="com.oxygenxml.webhelp.xsl.createMainPage.param"
        behavior="org.dita.dost.platform.InsertAction"/>      
      <sysproperty key="DOT_VERSION" value="${otversion}"/>
      
      <xmlcatalog>
        <xmlcatalog refid="xsl_extensions_catalog"/>
        <xmlcatalog refid="dita.catalog"/>
      </xmlcatalog>
    </xslt>

    <replaceregexp file="${output.dir}/index${out.ext}"
      match="&lt;\?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;\?&gt;" replace=""
      encoding="UTF-8"/>
  </target>

  <!--
    Create WebHelp Search Page, search.html.
  -->
  <target name="whr-create-search-page">    
    <property name="args.whr.create.search.page.xsl" value="${webhelp.responsive.dir}/xsl/mainFiles/createSearchPage.xsl"/>
    
    <xslt 
      processor="trax" 
      in="${webhelp.template.search.file}" 
      out="${output.dir}/search${out.ext}"
      style="${args.whr.create.search.page.xsl}" 
      force="yes" 
      classpathref="dost.class.path">
      <factory name="net.sf.saxon.TransformerFactoryImpl"/>
      <param name="TOC_XML_FILEPATH" expression="${output.dir}/toc.xml"/>
      <param name="INDEX_XML_FILEPATH" expression="${output.dir}/index.xml"/>
      <param name="XHTML_FOLDER" expression="${output.dir}"/>
      <param name="OUTPUTDIR" expression="${output.dir}"/>
      <param name="BASEDIR" expression="${webhelp.responsive.dir}"/>
      <param name="OUTEXT" expression="${out.ext}" if="out.ext"/>
      <param name="DEFAULTLANG" expression="${args.default.language}" if="args.default.language"/>
      <param name="CSS" expression="${args.css.file}" if="args.css.file"/>
      <param name="CSSPATH" expression="${user.csspath}" if="user.csspath"/>
      <param name="WEBHELP_LOGO_IMAGE" expression="${webhelp.logo.image.output}"
        if="webhelp.logo.image.output"/>
      <param name="WEBHELP_LOGO_IMAGE_TARGET_URL" expression="${webhelp.logo.image.target.url}"
        if="webhelp.logo.image.target.url"/>
      <param name="WEBHELP_FAVICON" expression="${webhelp.favicon.relpath}" if="webhelp.favicon.relpath"/>
      <param name="WEBHELP_SEARCH_RANKING" expression="${webhelp.search.ranking}"
        if="webhelp.search.ranking"/>
      <param name="WEBHELP_SEARCH_SCRIPT" expression="${webhelp.google.search.script.url}"
        if="webhelp.google.search.script.url"/>
      <param name="WEBHELP_SEARCH_RESULT" expression="${webhelp.google.search.results.url}"
        if="webhelp.google.search.results.url"/>
      <param name="WEBHELP_VERSION" expression="${webhelp.version}" if="webhelp.version"/>
      <param name="WEBHELP_BUILD_NUMBER" expression="${webhelp.build.number}"
        if="webhelp.build.number"/>
      <param name="WEBHELP_UNIQUE_ID" expression="${whr.gen.time}"/>      
      <param name="WEBHELP_TRIAL_LICENSE" expression="${webhelp.trial.license}"
        if="webhelp.trial.license"/>
      
      <param name="WEBHELP_DITAMAP_URL" expression="${org.dita-ot.html.map.url}"/>
      <param name="WEBHELP_PARAMETERS_URL" expression="${webhelp.responsive.parameters.file.url}"/>
      <param name="show.changes.and.comments" expression="${webhelp.show.changes.and.comments}"/>
      <!-- Navigation links params -->
      <param name="WEBHELP_TOP_MENU_TEMP_FILE_URL" expression="${webhelp.top.menu.temp.file.url}"/>
      
      <!-- 
        Extension point to pass parameters to the XSLT transformation that creates the main HTML page.
      -->
      <dita:extension id="com.oxygenxml.webhelp.xsl.createSearchPage.param"
        behavior="org.dita.dost.platform.InsertAction"/>
      <sysproperty key="DOT_VERSION" value="${otversion}"/>
      
      <xmlcatalog><xmlcatalog refid="xsl_extensions_catalog"/>
      <xmlcatalog refid="dita.catalog"/></xmlcatalog>
    </xslt>
  </target>


  <!--
    Create WebHelp indexterms page, indexTerms.html
  -->
  <target name="whr-create-indexterms-page">
    
    <property name="args.whr.create.indexterms.page.xsl" value="${webhelp.responsive.dir}/xsl/mainFiles/createIndextermsPage.xsl"/>
    <xslt 
      processor="trax" 
      in="${webhelp.template.index.terms.file}" 
      out="${output.dir}/indexTerms${out.ext}"
      style="${args.whr.create.indexterms.page.xsl}" 
      force="yes" 
      classpathref="dost.class.path">
      <factory name="net.sf.saxon.TransformerFactoryImpl"/>
      <param name="TOC_XML_FILEPATH" expression="${output.dir}/toc.xml"/>
      <param name="INDEX_XML_FILEPATH" expression="${output.dir}/index.xml"/>
      <param name="XHTML_FOLDER" expression="${output.dir}"/>
      <param name="OUTPUTDIR" expression="${output.dir}"/>
      <param name="BASEDIR" expression="${webhelp.responsive.dir}"/>
      <param name="OUTEXT" expression="${out.ext}" if="out.ext"/>
      <param name="DEFAULTLANG" expression="${args.default.language}" if="args.default.language"/>
      <param name="CSS" expression="${args.css.file}" if="args.css.file"/>
      <param name="CSSPATH" expression="${user.csspath}" if="user.csspath"/>
      <param name="WEBHELP_LOGO_IMAGE" expression="${webhelp.logo.image.output}"
        if="webhelp.logo.image.output"/>
      <param name="WEBHELP_LOGO_IMAGE_TARGET_URL" expression="${webhelp.logo.image.target.url}"
        if="webhelp.logo.image.target.url"/>
      <param name="WEBHELP_FAVICON" expression="${webhelp.favicon.relpath}" if="webhelp.favicon.relpath"/>
      <param name="WEBHELP_SEARCH_RANKING" expression="${webhelp.search.ranking}"
        if="webhelp.search.ranking"/>
      <param name="WEBHELP_SEARCH_SCRIPT" expression="${webhelp.google.search.script.url}"
        if="webhelp.google.search.script.url"/>
      <param name="WEBHELP_SEARCH_RESULT" expression="${webhelp.google.search.results.url}"
        if="webhelp.google.search.results.url"/>
      <param name="WEBHELP_VERSION" expression="${webhelp.version}" if="webhelp.version"/>
      <param name="WEBHELP_BUILD_NUMBER" expression="${webhelp.build.number}"
        if="webhelp.build.number"/>
      <param name="WEBHELP_UNIQUE_ID" expression="${whr.gen.time}"/>      
      <param name="WEBHELP_TRIAL_LICENSE" expression="${webhelp.trial.license}"
        if="webhelp.trial.license"/>
      
      <param name="WEBHELP_DITAMAP_URL" expression="${org.dita-ot.html.map.url}"/>
      <param name="WEBHELP_PARAMETERS_URL" expression="${webhelp.responsive.parameters.file.url}"/>
      <param name="show.changes.and.comments" expression="${webhelp.show.changes.and.comments}"/>
      
      <!-- Navigation links params -->
      <param name="WEBHELP_TOP_MENU_TEMP_FILE_URL" expression="${webhelp.top.menu.temp.file.url}"/>
      
      <!-- 
        TODO Extension point for indexterms.
      -->
      <dita:extension id="com.oxygenxml.webhelp.xsl.createIndexTermsPage.param"
        behavior="org.dita.dost.platform.InsertAction"/>
      <sysproperty key="DOT_VERSION" value="${otversion}"/>
      
      <xmlcatalog> <xmlcatalog refid="xsl_extensions_catalog"/>
      <xmlcatalog refid="dita.catalog"/></xmlcatalog>
    </xslt>
  </target>
  
  <!--
    Create WebHelp JS & PHP localization files (strings.js & strings.php).
  -->
  <target name="whr-create-localization-files">    
    
    <property 
       name="strings.list.file" 
       value="${webhelp.responsive.dir}/oxygen-webhelp/resources/localization/strings.xml"/>
    
    <xslt 
      processor="trax" 
      in="${strings.list.file}" 
      style="${webhelp.responsive.dir}/xsl/mainFiles/createLocalizationFiles.xsl" 
      force="yes" 
      out="${dita.temp.dir}/dummy.html"
      classpathref="dost.class.path">
      <factory name="net.sf.saxon.TransformerFactoryImpl"/>
      <param name="TOC_XML_FILEPATH" expression="${output.dir}/toc.xml"/>
      <param name="INDEX_XML_FILEPATH" expression="${output.dir}/index.xml"/>
      <param name="XHTML_FOLDER" expression="${output.dir}"/>
      <param name="OUTPUTDIR" expression="${output.dir}"/>
      <param name="BASEDIR" expression="${webhelp.responsive.dir}"/>
      <param name="OUTEXT" expression="${out.ext}" if="out.ext"/>
      <param name="DEFAULTLANG" expression="${args.default.language}" if="args.default.language"/>
      <param name="CSS" expression="${args.css.file}" if="args.css.file"/>
      <param name="CSSPATH" expression="${user.csspath}" if="user.csspath"/>
      <param name="WEBHELP_LOGO_IMAGE" expression="${webhelp.logo.image.output}"
        if="webhelp.logo.image.output"/>
      <param name="WEBHELP_LOGO_IMAGE_TARGET_URL" expression="${webhelp.logo.image.target.url}"
        if="webhelp.logo.image.target.url"/>
      <param name="WEBHELP_FAVICON" expression="${webhelp.favicon.relpath}" if="webhelp.favicon.relpath"/>
      <param name="WEBHELP_SEARCH_RANKING" expression="${webhelp.search.ranking}"
        if="webhelp.search.ranking"/>
      <param name="WEBHELP_SEARCH_SCRIPT" expression="${webhelp.google.search.script.url}"
        if="webhelp.google.search.script.url"/>
      <param name="WEBHELP_SEARCH_RESULT" expression="${webhelp.google.search.results.url}"
        if="webhelp.google.search.results.url"/>
      <param name="WEBHELP_VERSION" expression="${webhelp.version}" if="webhelp.version"/>
      <param name="WEBHELP_BUILD_NUMBER" expression="${webhelp.build.number}"
        if="webhelp.build.number"/>
      <param name="WEBHELP_UNIQUE_ID" expression="${whr.gen.time}"/>      
      <param name="WEBHELP_TRIAL_LICENSE" expression="${webhelp.trial.license}"
        if="webhelp.trial.license"/>
      
      <param name="WEBHELP_DITAMAP_URL" expression="${org.dita-ot.html.map.url}"/>
      <param name="WEBHELP_PARAMETERS_URL" expression="${webhelp.responsive.parameters.file.url}"/>
      <param name="show.changes.and.comments" expression="${webhelp.show.changes.and.comments}"/>
      
      <!-- 
        Extension point to pass parameters to the XSLT transformation that creates the main HTML page.
      -->
      <dita:extension id="com.oxygenxml.webhelp.xsl.createMainFiles.param"
        behavior="org.dita.dost.platform.InsertAction"/>
      <sysproperty key="DOT_VERSION" value="${otversion}"/>
      
      <xmlcatalog><xmlcatalog refid="xsl_extensions_catalog"/>
      <xmlcatalog refid="dita.catalog"/></xmlcatalog>
    </xslt>
    
    <delete dir="${dita.temp.dir}">
      <include name="dummy.html"/>
    </delete>
  </target>
  


  <!-- 
    DITa topics are converted to HTML files. 
  -->
  <target name="whr-dita-inner-topics" description="Build WebHelp output from dita topics"
    unless="noTopic">
    <property name="out.ext" value=".html"/>
    <property name="transtype.ext" value=".xsl"/>

    <property name="args.whr.topic.xsl" value="${webhelp.responsive.dir}/xsl/dita2webhelp/dita2webhelp.xsl"/>

    <!-- URL to the DITA Map -->
    <loadfile property="org.dita-ot.html.map" srcfile="${dita.temp.dir}/${user.input.file.listfile}">
      <filterchain>
        <headfilter lines="1"/>
      </filterchain>
    </loadfile>
    <makeurl property="org.dita-ot.html.map.url" file="${dita.temp.dir}/${org.dita-ot.html.map}"/>

    <makeurl file="${dita.input.valfile}" property="dita.input.valfile.url" validate="no"/>
    <makeurl property="webhelp.template.file.path.url" file="${webhelp.template.file.path}"/>
    
    <xslt processor="trax" basedir="${dita.temp.dir}" destdir="${output.dir}"
      includesfile="${dita.temp.dir}/${fullditatopicfile}" classpathref="dost.class.path"
      extension="${out.ext}" style="${args.whr.topic.xsl}" force="yes" filenameparameter="FILENAME"
      filedirparameter="FILEDIR" reloadstylesheet="${webhelp.reload.stylesheet}">
      <factory name="net.sf.saxon.TransformerFactoryImpl"/>
      <excludesfile name="${dita.temp.dir}/${resourceonlyfile}" if="resourceonlyfile"/>
      <includesfile name="${dita.temp.dir}/${chunkedtopicfile}" if="chunkedtopicfile"/>
      <param name="TRANSTYPE" expression="${transtype}"/>
      <param name="DITAEXT" expression="${dita.ext}" if="dita.ext"/>
      <param name="FILTERFILE" expression="${dita.input.valfile.url}" if="dita.input.valfile"/>
      <param name="HDF" expression="${args.hdf}" if="args.hdf"/>
      <param name="HDR" expression="${args.hdr}" if="args.hdr"/>
      <param name="FTR" expression="${args.ftr}" if="args.ftr"/>
      <param name="DRAFT" expression="${args.draft}" if="args.draft"/>
      <param name="ARTLBL" expression="${args.artlbl}" if="args.artlbl"/>
      <param name="GENERATE-TASK-LABELS" expression="${args.gen.task.lbl}" if="args.gen.task.lbl"/>
      <param name="PRESERVE-DITA-CLASS" expression="${args.xhtml.classattr}"
        if="args.xhtml.classattr"/>
      <param name="NOPARENTLINK" expression="${args.hide.parent.link}" if="args.hide.parent.link"/>
      <param name="include.rellinks" expression="${include.rellinks}" if="include.rellinks"/>
      <param name="BREADCRUMBS" expression="${args.breadcrumbs}" if="args.breadcrumbs"/>
      <param name="INDEXSHOW" expression="${args.indexshow}" if="args.indexshow"/>
      <param name="genDefMeta" expression="${args.gen.default.meta}" if="args.gen.default.meta"/>
      <param name="OUTEXT" expression="${out.ext}" if="out.ext"/>
      <param name="BASEDIR" expression="${basedir}"/>
      <param name="OUTPUTDIR" expression="${output.dir}"/>
      <!-- WH-257: Parameter used in commonComponentsExpander.xsl -->
      <param name="TEMPDIR" expression="${dita.temp.dir}"/>
      <param name="LANGUAGE" expression="${args.default.language}" if="args.default.language"/>
      <param name="DBG" expression="${args.debug}" if="args.debug"/>
      <param name="CSS" expression="${args.css.file}" if="args.css.file"/>
      <param name="CSSPATH" expression="${user.csspath}" if="user.csspath"/>
      <param name="CUSTOM_BASEDIR" expression="${dita.temp.dir}"/>
      <param name="WEBHELP_FOOTER_INCLUDE" expression="${webhelp.footer.include}"
        if="webhelp.footer.include"/>
      <param name="WEBHELP_FOOTER_FILE" expression="${webhelp.footer.file}" if="webhelp.footer.file"/>
      <param name="WEBHELP_TRIAL_LICENSE" expression="${webhelp.trial.license}"
        if="webhelp.trial.license"/>
      <param name="WEBHELP_SEARCH_SCRIPT" expression="${webhelp.google.search.script.url}"
        if="webhelp.google.search.script.url"/>
      <param name="WEBHELP_PRODUCT_ID" expression="${webhelp.product.id}" if="webhelp.product.id"/>
      <param name="WEBHELP_PRODUCT_VERSION" expression="${webhelp.product.version}"
        if="webhelp.product.version"/>
      <param name="WEBHELP_VERSION" expression="${webhelp.version}" if="webhelp.version"/>
      <param name="WEBHELP_BUILD_NUMBER" expression="${webhelp.build.number}"
        if="webhelp.build.number"/>
      <param name="WEBHELP_UNIQUE_ID" expression="${whr.gen.time}"/>
      <param name="INDEX_XML_FILEPATH" expression="${output.dir}/index.xml"/>
      <param name="WEBHELP_FAVICON" expression="${webhelp.favicon.relpath}" if="webhelp.favicon.relpath"/>

      <!-- URL to the DITA map is necesary only for responsive webhelp -->
      <param name="TOC_XML_FILEPATH" expression="${output.dir}/toc.xml"/>
      <param name="WEBHELP_DITAMAP_URL" expression="${org.dita-ot.html.map.url}"/>
      <param name="WEBHELP_TEMPLATE_URL" expression="${webhelp.template.file.path.url}"/>
      <param name="WEBHELP_LOGO_IMAGE" expression="${webhelp.logo.image.output}"
        if="webhelp.logo.image.output"/>
      <param name="WEBHELP_LOGO_IMAGE_TARGET_URL" expression="${webhelp.logo.image.target.url}"
        if="webhelp.logo.image.target.url"/>
      <param name="WEBHELP_DEBUG_DITA_OT_OUTPUT" expression="${webhelp.debug.dita.ot.output}"/>
      <param name="WEBHELP_PARAMETERS_URL" expression="${webhelp.responsive.parameters.file.url}"/>
      <param name="show.changes.and.comments" expression="${webhelp.show.changes.and.comments}"/>
      
      <!-- Navigation links params -->
      <param name="WEBHELP_TOP_MENU_TEMP_FILE_URL" expression="${webhelp.top.menu.temp.file.url}"/>
      
      <dita:extension id="dita.conductor.xhtml.param" behavior="org.dita.dost.platform.InsertAction"/>
      <!-- 
        Extension point to pass parameters to the XSLT transformation.
      -->
      <dita:extension id="com.oxygenxml.webhelp.xsl.dita2webhelp.param"
        behavior="org.dita.dost.platform.InsertAction"/>
      <sysproperty key="DOT_VERSION" value="${otversion}"/>
      
      <xmlcatalog> <xmlcatalog refid="xsl_extensions_catalog"/>
      <xmlcatalog refid="dita.catalog"/></xmlcatalog>
    </xslt>
  </target>

  <!-- 
    Generate 'context-help-map.xml' used by Context Sensitive Help system.
  -->
  <target name="whr-context-help-map">
    <!-- Create context-help-map.xml -->
    <xslt processor="trax" in="${dita.temp.dir}/${user.input.file}"
      out="${output.dir}/context-help-map.xml"
      style="${webhelp.responsive.dir}/xsl/contextHelp/contextHelpMapDita.xsl" force="yes"
      classpathref="dost.class.path" reloadstylesheet="${webhelp.reload.stylesheet}">
      <param name="OUT_EXT" expression="${out.ext}"/>
      <param name="WEBHELP_PRODUCT_ID" expression="${webhelp.product.id}" if="webhelp.product.id"/>
      <param name="WEBHELP_PRODUCT_VERSION" expression="${webhelp.product.version}"
        if="webhelp.product.version"/>
      <sysproperty key="DOT_VERSION" value="${otversion}"/>
      
      <xmlcatalog><xmlcatalog refid="xsl_extensions_catalog"/>
      <xmlcatalog refid="dita.catalog"/></xmlcatalog>
    </xslt>
    
    <!-- Create context-help-map.js -->
    <xslt processor="trax" in="${output.dir}/context-help-map.xml"
      out="${output.dir}/context-help-map.js"
      style="${webhelp.responsive.dir}/xsl/contextHelp/contextHelpMapDitaJS.xsl" force="yes"
      classpathref="dost.class.path" reloadstylesheet="${webhelp.reload.stylesheet}">
      
      <xmlcatalog><xmlcatalog refid="xsl_extensions_catalog"/>
      <xmlcatalog refid="dita.catalog"/></xmlcatalog>
    </xslt>
    
  </target>

  <!-- 
    Create toc.xml containing the documentation hierarchy. 
  -->
  <target name="whr-toc-xml"
    description="Build WebHelp Responsive toc.xml file">
    <makeurl file="${dita.input.valfile}" property="dita.input.valfile.url" validate="no"/>

    <makeurl file="${dita.temp.dir}" property="dita.temp.dir.url"/>

    <property name="args.whr.createTocXML.xsl" value="${webhelp.responsive.dir}/xsl/navLinks/tocDita.xsl"/>
    <xslt processor="trax" in="${dita.temp.dir}/${user.input.file}" out="${output.dir}/toc.xml"
      style="${args.whr.createTocXML.xsl}" force="yes" classpathref="dost.class.path"
      reloadstylesheet="${webhelp.reload.stylesheet}">
      <param name="OUT_EXT" expression="${out.ext}"/>
      <param name="FILTERFILE" expression="${dita.input.valfile.url}" if="dita.input.valfile"/>
      <param name="WEBHELP_PARAMETERS_URL" expression="${webhelp.responsive.parameters.file.url}"/>
      <param name="TEMP_DIR_URL" expression="${dita.temp.dir.url}"/>  

      <!-- 
        Extension point to pass parameters to the XSLT transformation that creates the 'toc.xml' file.
      -->
      <dita:extension id="com.oxygenxml.webhelp.xsl.createTocXML.param"
        behavior="org.dita.dost.platform.InsertAction"/>

      <sysproperty key="DOT_VERSION" value="${otversion}"/>
      <outputproperty name="method" value="xhtml"/>
      
      <xmlcatalog> <xmlcatalog refid="xsl_extensions_catalog"/>
      <xmlcatalog refid="dita.catalog"/></xmlcatalog>
    </xslt>
  </target>
  
  <target name="whr-nav-links">
    
    <makeurl file="${dita.temp.dir}" property="dita.temp.dir.url"/>
    
    <property name="nav.json.out.dir" value="${output.dir}/oxygen-webhelp/nav-links/json"/>
    <makeurl property="nav.json.out.dir.url" file="${nav.json.out.dir}" validate="false"/>
    
    <xslt 
      processor="trax" 
      in="${output.dir}/toc.xml"
      out="${dita.temp.dir}/navlinks-dummy.html"
      style="${webhelp.responsive.dir}/xsl/navLinks/navLinks.xsl" 
      force="yes" 
      classpathref="dost.class.path"
      reloadstylesheet="${webhelp.reload.stylesheet}">
      <param name="TEMP_DIR_URL" expression="${dita.temp.dir.url}"/>
      <param name="WEBHELP_SIDE_TOC_LINKS" expression="${webhelp.side.toc.links}"/>
      <param name="MENU_TEMP_FILE_URI" expression="${webhelp.top.menu.temp.file.url}"/>
      <param name="WEBHELP_TOP_MENU_DEPTH" expression="${webhelp.top.menu.depth}"/>
      <param name="JSON_OUTPUT_DIR_URI" expression="${nav.json.out.dir.url}"/>
      <sysproperty key="DOT_VERSION" value="${otversion}"/>
      
      <xmlcatalog><xmlcatalog refid="xsl_extensions_catalog"/>
        <xmlcatalog refid="dita.catalog"/></xmlcatalog>
    </xslt>
    <delete file="${dita.temp.dir}/navlinks-dummy.html"/>
  </target>
  
  <!--
    Generate the 'sitemap.xml' file. It can be used for search engine optiomization. 
    See https://www.oxygenxml.com/doc/versions/19.0/ug-editor/topics/webhelp-seo-x-publishing3.html.
  -->
  <target name="whr-sitemap" if="webhelp.sitemap.base.url">
    <tstamp>
      <format property="webhelp.sitemap.date" pattern="yyyy-MM-dd"/>
    </tstamp>

    <xslt processor="trax" in="${dita.temp.dir}/${user.input.file}" out="${output.dir}/sitemap.xml"
      style="${webhelp.responsive.dir}/xsl/search/sitemapDita.xsl" force="yes" classpathref="dost.class.path"
      reloadstylesheet="${webhelp.reload.stylesheet}">
      <param name="OUT_EXT" expression="${out.ext}"/>
      <param name="WEBHELP_BASE_URL" expression="${webhelp.sitemap.base.url}"
        if="webhelp.sitemap.base.url"/>
      <param name="WEBHELP_LAST_MODIFIED" expression="${webhelp.sitemap.date}"/>
      <param name="WEBHELP_CHANGE_FREQUENCY" expression="${webhelp.sitemap.change.frequency}"
        if="webhelp.sitemap.change.frequency"/>
      <param name="WEBHELP_PRIORITY" expression="${webhelp.sitemap.priority}"
        if="webhelp.sitemap.priority"/>
      <sysproperty key="DOT_VERSION" value="${otversion}"/>
      
      <xmlcatalog><xmlcatalog refid="xsl_extensions_catalog"/>
      <xmlcatalog refid="dita.catalog"/></xmlcatalog>
    </xslt>
  </target>

  <target name="whr-copy-resources"
    depends="
       whr-copy-logo-image,
       whr-copy-favicon,
       whr-copy-custom-resources,
       whr-copy-common-resources,
       whr-copy-feedback-resources,
       whr-copy-template-resources"/>

  <!-- Copy additional template resources. -->
  <target name="whr-copy-template-resources">
    <if>
      <!-- External template was specified -->
      <isset property="webhelp.publishing.template"/>
      <then>
        <antcall target="whr-copy-custom-template-resources"/>
      </then>      

      <!-- Custom skin is specified -->
      <elseif>
        <isset property="webhelp.responsive.custom.skin"/>
        <then>
          <antcall target="whr-copy-template-resources-custom-skin"/>
        </then>
      </elseif>
      <!-- Copy resources from built-in skin -->
      <else>
        <antcall target="whr-copy-template-resources-builtin-skin"/>
      </else>
    </if>
  </target>
  
  <!--
    Copy custom template resources.
  -->
  <target name="whr-copy-custom-template-resources">
    <echo>Copying custom template resources. Ant file: ${webhelp.copy.resources.ant.file.path}</echo>
    <ant antfile="${webhelp.copy.resources.ant.file.path}" target="copy-template-resources" usenativebasedir="true"/>
  </target>
  
  <!--
    Copy resources(CSS, JS) from template's folder.
  -->
  <target name="whr-copy-template-resources-builtin-skin" unless="webhelp.responsive.custom.skin">
    <mkdir dir="${output.dir}/oxygen-webhelp/template"/>

    <copy todir="${output.dir}/oxygen-webhelp/template">
      <fileset dir="${webhelp.responsive.template.dir}">
        <include name="resources/**/*"/>
        <include name="variants/${webhelp.responsive.variant.name}/resources/**/*"/>
        <include
          name="variants/${webhelp.responsive.variant.name}/${webhelp.responsive.skin.name}/resources/**/*"/>
        <include
          name="variants/${webhelp.responsive.variant.name}/${webhelp.responsive.skin.name}/skin.css"/>

        <exclude name="**/.svn"/>
        <exclude name="**/.git"/>
      </fileset>
    </copy>
  </target>

  <!--
    Copy resources from template's dir when a custom skin was specified.
  -->
  <target name="whr-copy-template-resources-custom-skin" if="webhelp.responsive.custom.skin">
    <mkdir dir="${output.dir}/oxygen-webhelp/template"/>
    <mkdir
      dir="${output.dir}/oxygen-webhelp/template/variants/${webhelp.responsive.variant.name}/custom"/>

    <copy todir="${output.dir}/oxygen-webhelp/template">
      <fileset dir="${webhelp.responsive.template.dir}">
        <include name="resources/**/*"/>
        <include name="variants/${webhelp.responsive.variant.name}/resources/**/*"/>

        <exclude name="**/.svn"/>
        <exclude name="**/.git"/>
      </fileset>
    </copy>

    <dirname property="custom.skin.dir" file="${webhelp.responsive.custom.skin}"/>

    <copy
      todir="${output.dir}/oxygen-webhelp/template/variants/${webhelp.responsive.variant.name}/custom">
      <fileset dir="${custom.skin.dir}">
        <include name="resources/**/*"/>

        <exclude name="**/.svn"/>
        <exclude name="**/.git"/>
      </fileset>
    </copy>

    <copyfile src="${webhelp.responsive.custom.skin}"
      dest="${output.dir}/oxygen-webhelp/template/variants/${webhelp.responsive.variant.name}/custom/skin.css"
    />
  </target>

  <!-- Target executed before indexing the HTML files -->
  <target name="whr-search-index-preprocess">
    <!-- Collect the topics marked with @search="no" in order to exclude them from search indexer -->
    <property name="create.search.excludes.xsl"
      value="${webhelp.responsive.dir}/xsl/search/createSearchExcludesFile.xsl"/>
    <property name="search.excludes.file"
      value="${output.dir}/oxygen-webhelp/search/search-excludes.txt"/>
    <xslt processor="trax" in="${dita.temp.dir}/${user.input.file}" out="${search.excludes.file}"
      style="${create.search.excludes.xsl}" force="yes" classpathref="dost.class.path"
      reloadstylesheet="${webhelp.reload.stylesheet}">

      <factory name="net.sf.saxon.TransformerFactoryImpl"/>
      <outputproperty name="method" value="text"/>
      <outputproperty name="omit-xml-declaration" value="yes"/>

      <param name="OUT_EXTENSION" expression="${out.ext}"/>
      
     <xmlcatalog> 
       <xmlcatalog refid="xsl_extensions_catalog"/>
      <xmlcatalog refid="dita.catalog"/></xmlcatalog>
    </xslt>
    <available file="${search.excludes.file}" property="search.excludes.file.exists"/>
  </target>
</project>
