<?xml version="1.0" encoding="utf-8"?><!--
    
Oxygen WebHelp Plugin
Copyright (c) 1998-2017 Syncro Soft SRL, Romania.  All rights reserved.

--><!-- Extend the toolkit's XHTML processing to generate WebHelp output. --><project name="webhelp.classic.integrator" default="dita2webhelp" basedir=".">
  
  <!-- Directory of the Webhelp plugin. -->
  <property name="webhelp.classic.dir" value="${dita.plugin.com.oxygenxml.webhelp.classic.dir}"></property>
  
  <import file="build_common.xml"></import>
  
  <target name="dita2webhelp-common" depends="webhelp-build-init,build-init,check-license,check-webhelp-feedback-parameters,dita.map.webhelp.init,preprocess,dita.out.map.webhelp.toc,dita.webhelp.sitemap.xml,copy-webhelp-resources,copy-css,dita.topics.xhtml,webhelp-indexterms,dita.inner.topics.webhelp,dita.outer.topics.xhtml,create-main-files,copy-webhelp-feedback-localization,webhelp-index"></target>
	
  <target name="dita2webhelp" depends="dita2webhelp-common"></target>
  
  <target name="webhelp-build-init">
    <condition property="webhelp.reload.stylesheet" value="false">
      <not><isset property="webhelp.reload.stylesheet"></isset></not>
    </condition>
    <!-- By default the mobile is off. It will be turned on from specific targets. 
  <property name="webhelp.mobile" value=""/>
  -->
    
    <property name="webhelp.parameters.file" location="${dita.temp.dir}/props.xml"></property>
    
    <!--We load the ditaotversion param from this DITA-OT configuration properties file.-->
    <loadproperties srcfile="${dita.dir}/lib/configuration.properties"></loadproperties>
    
    <!-- Google search parameters: convert the file paths to URLs -->
    <if>
      <isset property="webhelp.google.search.script"></isset>
      <then>
        <makeurl property="webhelp.google.search.script.url" file="${webhelp.google.search.script}"></makeurl>
      </then>
    </if>
    <if>
      <isset property="webhelp.google.search.results"></isset>
      <then>
        <makeurl property="webhelp.google.search.results.url" file="${webhelp.google.search.results}"></makeurl>
      </then>
    </if>
    
    <!-- 
      EXM-39143: Setting this to true ensures that unique output files are created for each instance of a 
      resource when a map contains multiple references to a single topic. 
    -->  
    <property name="force-unique" value="true"></property>  
  </target>
	
  <!-- The same as the classic target, but adds a parameter we can pass to the stylesheets. -->
  <target name="dita2webhelp-mobile">
    <property name="is.webhelp.mobile" value="true"></property>
    
  	<antcall target="dita2webhelp">
  		<param name="webhelp.mobile" value="mobile"></param>
  	</antcall>
  </target>
  
  <target name="dita2webhelp-feedback" depends="dita2webhelp-common"></target>
    
  <!-- The same as the classic target, but adds a parameter we can pass to the stylesheets. -->
  <target name="dita2webhelp-feedback-mobile">
  	<antcall target="dita2webhelp-feedback">
  		<param name="webhelp.mobile" value="mobile"></param>
  	</antcall>
  </target>
	
  <property name="webhelp.plugin.path" value="${webhelp.classic.dir}/"></property>
  
    <!-- Default language for translated strings in HTML pages. Should be set by caller process. -->
    <property name="args.default.language" value="en-US"></property>
    
   <!--EXM-22509 Set to args.xhtml.toc a default value -->
  <target name="dita.map.webhelp.init">
    <condition property="out.ext" value=".html">
      <not>
        <isset property="out.ext"></isset>
      </not>
    </condition>
    <condition property="args.xhtml.toc" value="toc">
      <not>
        <isset property="args.xhtml.toc"></isset>
      </not>
    </condition>
  </target> 
	
  <!-- Declare the foreach and if else tasks. -->
  <taskdef resource="net/sf/antcontrib/antlib.xml">
    <classpath>
      <pathelement location="${webhelp.classic.dir}/lib/ant-contrib-1.0b3.jar"></pathelement>
    </classpath>
  </taskdef>
	
    <target name="detectIndexerLang">
    	<property name="inputMap" value="${dita.temp.dir}/${user.input.file}"></property>
    
    	<taskdef name="detect-lang" classname="com.suite.sol.ditaot.DetectLang">
    		<classpath path="${dita.dir}/plugins/org.dita.pdf2/lib/fo.jar"></classpath>
    	</taskdef>
    	
    	<!-- Set document.locale from xml:lang -->
         <!-- The map takes precedence, followed by the first topic -->
         <detect-lang documentPath="${inputMap}"></detect-lang>
    
        <!-- Set webhelp.language property -->
        <if>
            <isset property="document.locale"></isset>
            <then>
                <!-- Use use propertyregex from antcontrib -->
                <propertyregex property="webhelp.language" input="${document.locale}" regexp="(..)" select="\1" defaultvalue="en" override="true"></propertyregex>
            </then>
         <else>
      	  <if>
      	    <isset property="args.default.language"></isset>
       	    <then>
           		<!-- Use use propertyregex from antcontrib -->
               	<propertyregex property="webhelp.language" input="${args.default.language}" regexp="(..)" select="\1" defaultvalue="en" override="true"></propertyregex>
       	 	</then>
    	  </if>
        </else>
       </if>
       <echo>Indexer language=${webhelp.language}</echo>
    </target>
  

  <target name="webhelp-indexterms" description="Build list of index terms" unless="noTopic">
    <property name="args.extract.indexterms.xsl" value="${webhelp.classic.dir}/xsl/dita/indexterms/extractIndexterms.xsl"></property>
    <makeurl property="dita.temp.dir.url" file="${dita.temp.dir}"></makeurl>
    <xslt processor="trax" basedir="${dita.temp.dir}" destdir="${dita.temp.dir}" includesfile="${dita.temp.dir}/${fullditatopicfile}" excludesfile="${dita.temp.dir}/${resourceonlyfile}" style="${args.extract.indexterms.xsl}" classpathref="dost.class.path" reloadstylesheet="${webhelp.reload.stylesheet}">
      <factory name="net.sf.saxon.TransformerFactoryImpl"></factory>
      <param name="TEMPFOLDER" expression="${dita.temp.dir.url}"></param>
      <param name="OUT_EXT" expression="${out.ext}"></param>
      <mapper type="regexp" from="^(.*?)$$" to="\1.indexterms"></mapper>
      <sysproperty key="DOT_VERSION" value="${otversion}"></sysproperty>
      <xmlcatalog refid="dita.catalog"></xmlcatalog>
    </xslt>
    
    <property name="args.collect.indexterms.xsl" value="${webhelp.classic.dir}/xsl/dita/indexterms/collectIndexterms.xsl"></property>
    <xslt processor="trax" in="${dita.temp.dir}/${user.input.file}" out="${output.dir}/index.xml" style="${args.collect.indexterms.xsl}" classpathref="dost.class.path" reloadstylesheet="${webhelp.reload.stylesheet}">
      <factory name="net.sf.saxon.TransformerFactoryImpl"></factory>
      <param name="TEMPFOLDER" expression="${dita.temp.dir}"></param>
      <param name="FILELIST" expression="${dita.temp.dir}/${fullditatopicfile}"></param>
      <param name="FILELIST_TO_EXCLUDE" expression="${dita.temp.dir}/${resourceonlyfile}"></param>
      <param name="FILELIST_ENCODING" expression="${file.encoding}"></param>
      <sysproperty key="DOT_VERSION" value="${otversion}"></sysproperty>
      <xmlcatalog refid="dita.catalog"></xmlcatalog>
    </xslt>
  </target>
  
  
    <target name="add-links" if="${is.webhelp.mobile}">
        <property name="input.map" value="${dita.temp.dir}/${user.input.file}"></property>
        <property name="output.map" value="${dita.temp.dir}/${user.input.file}.links"></property>
        <property name="add.links.xslt" value="${webhelp.classic.dir}/xsl/dita/mobile/addLinks.xsl"></property>
        <xslt processor="trax" in="${input.map}" out="${output.map}" style="${add.links.xslt}" reloadstylesheet="${webhelp.reload.stylesheet}">
          <sysproperty key="DOT_VERSION" value="${otversion}"></sysproperty>
          <xmlcatalog refid="dita.catalog"></xmlcatalog>
        </xslt>
        <delete file="${input.map}"></delete>
        <move file="${output.map}" tofile="${input.map}"></move>
    </target>
    
	
	<!--
		Converts the oXygen review PIs (change tracking, comments, etc..) into elements, and 
		structures the replies into the parent comments. 
	-->
	<target name="process.reviews" if="${webhelp.show.changes.and.comments}">
	    
	    <echo>Transforming Oxygen PIs into elements.</echo>
		
	    <xslt processor="trax" basedir="${dita.temp.dir}" destdir="${dita.temp.dir}.1" includesfile="${dita.temp.dir}/${fullditatopicfile}" style="${dita.plugin.com.oxygenxml.webhelp.classic.dir}/xsl/review/review-pis-to-elements.xsl" force="yes" failOnError="yes" failOnTransformationError="yes" reloadstylesheet="${webhelp.reload.stylesheet}">
	      
	      <factory name="net.sf.saxon.TransformerFactoryImpl"></factory>

	      <excludesfile name="${dita.temp.dir}/${resourceonlyfile}" if="resourceonlyfile"></excludesfile>
	      <includesfile name="${dita.temp.dir}/${chunkedtopicfile}" if="chunkedtopicfile"></includesfile>
	      <param name="show.changes.and.comments" expression="${webhelp.show.changes.and.comments}"></param>
	      
	      <xmlcatalog refid="dita.catalog"></xmlcatalog>      
	      <mapper type="identity"></mapper>
	    </xslt>
	    

	    <echo>Grouping comments into threads.</echo>

	    <xslt processor="trax" basedir="${dita.temp.dir}.1" destdir="${dita.temp.dir}" includesfile="${dita.temp.dir}/${fullditatopicfile}" style="${dita.plugin.com.oxygenxml.webhelp.classic.dir}/xsl/review/review-group-replies.xsl" force="yes" failOnError="yes" failOnTransformationError="yes" reloadstylesheet="${webhelp.reload.stylesheet}">
	      
	      <factory name="net.sf.saxon.TransformerFactoryImpl"></factory>
	      <excludesfile name="${dita.temp.dir}/${resourceonlyfile}" if="resourceonlyfile"></excludesfile>
	      <includesfile name="${dita.temp.dir}/${chunkedtopicfile}" if="chunkedtopicfile"></includesfile>
	      <param name="show.changes.and.comments" expression="${webhelp.show.changes.and.comments}"></param>
	      
	      <xmlcatalog refid="dita.catalog"></xmlcatalog>      
	      <mapper type="identity"></mapper>
	    </xslt>	    
	</target>
	
  <!-- Create the index.html and toc.html files. -->  
  <target name="create-main-files" depends="check-image-file-exist ">
    <if>
      <istrue value="${is.webhelp.mobile}"></istrue>
      <then>
        <property name="args.create.main.files.xsl" value="${webhelp.classic.dir}/xsl/dita/mobile/createMainFiles.xsl"></property>
      </then>
      <else>
        <property name="args.create.main.files.xsl" value="${webhelp.classic.dir}/xsl/dita/desktop/createMainFiles.xsl"></property>    
      </else>
    </if>    
    
    <echo message="Stylesheet: ${args.create.main.files.xsl}"></echo>
    <xslt processor="trax" in="${dita.temp.dir}/${user.input.file}" out="${output.dir}/dummy.html" style="${args.create.main.files.xsl}" force="yes" classpathref="dost.class.path" reloadstylesheet="${webhelp.reload.stylesheet}">
      <factory name="net.sf.saxon.TransformerFactoryImpl"></factory>
      <param name="TOC_XML_FILEPATH" expression="${output.dir}/toc.xml"></param>
      <param name="INDEX_XML_FILEPATH" expression="${output.dir}/index.xml"></param>
      <param name="XHTML_FOLDER" expression="${output.dir}"></param>
      <param name="OUTPUTDIR" expression="${output.dir}"></param>
      <param name="BASEDIR" expression="${webhelp.classic.dir}"></param>
      <param name="OUTEXT" expression="${out.ext}" if="out.ext"></param>
      <param name="DEFAULTLANG" expression="${args.default.language}" if="args.default.language"></param>
      <param name="WEBHELP_COPYRIGHT" expression="${webhelp.copyright}" if="webhelp.copyright"></param>
      <param name="CSS" expression="${args.css.file}" if="args.css.file"></param>
      <param name="CSSPATH" expression="${user.csspath}" if="user.csspath"></param>
      <param name="WEBHELP_SKIN_CSS" expression="${output.webhelp.skin.css}" if="output.webhelp.skin.css"></param>
      <param name="WEBHELP_LOGO_IMAGE" expression="${webhelp.logo.image.output}" if="webhelp.logo.image.output"></param>
      <param name="WEBHELP_LOGO_IMAGE_TARGET_URL" expression="${webhelp.logo.image.target.url}" if="webhelp.logo.image.target.url"></param>
      <param name="WEBHELP_FAVICON" expression="${webhelp.favicon.file}" if="webhelp.favicon.file"></param>
      <param name="WEBHELP_SEARCH_RANKING" expression="${webhelp.search.ranking}" if="webhelp.search.ranking"></param>
      <param name="WEBHELP_HEAD_SCRIPT" expression="${webhelp.head.script}" if="webhelp.head.script"></param>
      <param name="WEBHELP_SEARCH_SCRIPT" expression="${webhelp.google.search.script.url}" if="webhelp.google.search.script.url"></param>
      <param name="WEBHELP_SEARCH_RESULT" expression="${webhelp.google.search.results.url}" if="webhelp.google.search.results.url"></param>
      <param name="WEBHELP_BODY_SCRIPT" expression="${webhelp.body.script}" if="webhelp.body.script"></param>
      <param name="WEBHELP_VERSION" expression="${webhelp.version}" if="webhelp.version"></param>
      <param name="WEBHELP_BUILD_NUMBER" expression="${webhelp.build.number}" if="webhelp.build.number"></param>
      <param name="WEBHELP_UNIQUE_ID" expression="${gen.time}"></param>
      <param name="WEBHELP_FOOTER_INCLUDE" expression="${webhelp.footer.include}" if="webhelp.footer.include"></param>
      <param name="WEBHELP_FOOTER_FILE" expression="${webhelp.footer.file}" if="webhelp.footer.file"></param>
      <param name="WEBHELP_TRIAL_LICENSE" expression="${webhelp.trial.license}" if="webhelp.trial.license"></param>

      <param name="show.changes.and.comments" expression="${webhelp.show.changes.and.comments}"></param>
      
      <!-- 
        Extension point to pass parameters to the XSLT transformation that creates the main HTML page.
      -->
      
      <sysproperty key="DOT_VERSION" value="${otversion}"></sysproperty>
      <xmlcatalog refid="dita.catalog"></xmlcatalog>
    </xslt>
      
    <replaceregexp file="${output.dir}/index.html" match="&lt;\?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;\?&gt;" replace="" encoding="UTF-8"></replaceregexp>
    <if>
      <not><isset property="webhelp.mobile"></isset></not>
      <then>
        <replaceregexp file="${output.dir}/toc.html" match="&lt;\?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;\?&gt;" replace="" encoding="UTF-8"></replaceregexp>
      </then>
    </if>
    <delete dir="${output.dir}">
      <include name="dummy.html"></include>
      <include name="index.xml"></include>
      <include name="index_frames.html" if="webhelp.mobile"></include>
      <include name="toc.html" if="webhelp.mobile"></include>
    </delete>
  </target>
  
  
  <!-- Customize header and footer of each topic. -->
  <target name="dita.inner.topics.webhelp" description="Build WebHelp output from dita topics" unless="noTopic">
    <property name="out.ext" value=".html"></property>
    <property name="transtype.ext" value=".xsl"></property>

    <if>
      <isset property="webhelp.mobile"></isset>
      <then>
        <property name="args.wh.xsl" value="${webhelp.classic.dir}/xsl/dita/mobile/dita2webhelp.xsl"></property>
      </then>
      
      <else>
        <property name="args.wh.xsl" value="${webhelp.classic.dir}/xsl/dita/desktop/dita2webhelp.xsl"></property>
      </else>
    </if>
    
    <!-- URL to the DITA Map -->
    <loadfile property="org.dita-ot.html.map" srcfile="${dita.temp.dir}/${user.input.file.listfile}">
      <filterchain>
        <headfilter lines="1"></headfilter>
      </filterchain>
    </loadfile>
    <makeurl property="org.dita-ot.html.map.url" file="${dita.temp.dir}/${org.dita-ot.html.map}"></makeurl>
    
    <makeurl file="${dita.input.valfile}" property="dita.input.valfile.url" validate="no"></makeurl>
    
  	<antcall target="process.reviews"></antcall>

    <xslt processor="trax" basedir="${dita.temp.dir}" destdir="${output.dir}" includesfile="${dita.temp.dir}/${fullditatopicfile}" classpathref="dost.class.path" extension="${out.ext}" style="${args.wh.xsl}" force="yes" filenameparameter="FILENAME" filedirparameter="FILEDIR" reloadstylesheet="${webhelp.reload.stylesheet}">
      <factory name="net.sf.saxon.TransformerFactoryImpl"></factory>
      <excludesfile name="${dita.temp.dir}/${resourceonlyfile}" if="resourceonlyfile"></excludesfile>
      <includesfile name="${dita.temp.dir}/${chunkedtopicfile}" if="chunkedtopicfile"></includesfile>
      <param name="TRANSTYPE" expression="${transtype}"></param>
      <param name="DITAEXT" expression="${dita.ext}" if="dita.ext"></param>
      <param name="FILTERFILE" expression="${dita.input.valfile.url}" if="dita.input.valfile"></param>
      <param name="HDF" expression="${args.hdf}" if="args.hdf"></param>
      <param name="HDR" expression="${args.hdr}" if="args.hdr"></param>
      <param name="FTR" expression="${args.ftr}" if="args.ftr"></param>
      <param name="DRAFT" expression="${args.draft}" if="args.draft"></param>
      <param name="ARTLBL" expression="${args.artlbl}" if="args.artlbl"></param>
      <param name="GENERATE-TASK-LABELS" expression="${args.gen.task.lbl}" if="args.gen.task.lbl"></param>
      <param name="PRESERVE-DITA-CLASS" expression="${args.xhtml.classattr}" if="args.xhtml.classattr"></param>
      <param name="NOPARENTLINK" expression="${args.hide.parent.link}" if="args.hide.parent.link"></param>
      <param name="include.rellinks" expression="${include.rellinks}" if="include.rellinks"></param>
      <param name="BREADCRUMBS" expression="${args.breadcrumbs}" if="args.breadcrumbs"></param>
      <param name="INDEXSHOW" expression="${args.indexshow}" if="args.indexshow"></param>
      <param name="genDefMeta" expression="${args.gen.default.meta}" if="args.gen.default.meta"></param>
      <param name="OUTEXT" expression="${out.ext}" if="out.ext"></param>
      <param name="BASEDIR" expression="${basedir}"></param>
      <param name="OUTPUTDIR" expression="${output.dir}"></param>
      <param name="LANGUAGE" expression="${args.default.language}" if="args.default.language"></param>
      <param name="DBG" expression="${args.debug}" if="args.debug"></param>
      <param name="CSS" expression="${args.css.file}" if="args.css.file"></param>
      <param name="CSSPATH" expression="${user.csspath}" if="user.csspath"></param>
      <param name="WEBHELP_SKIN_CSS" expression="${output.webhelp.skin.css}" if="output.webhelp.skin.css"></param>
      <param name="CUSTOM_RATE_PAGE_URL" expression="${custom.rate.page.url}" if="custom.rate.page.url"></param>
      <param name="CUSTOM_BASEDIR" expression="${dita.temp.dir}"></param>
      <param name="WEBHELP_FOOTER_INCLUDE" expression="${webhelp.footer.include}" if="webhelp.footer.include"></param>
      <param name="WEBHELP_FOOTER_FILE" expression="${webhelp.footer.file}" if="webhelp.footer.file"></param>
      <param name="WEBHELP_TRIAL_LICENSE" expression="${webhelp.trial.license}" if="webhelp.trial.license"></param>
      <param name="WEBHELP_HEAD_SCRIPT" expression="${webhelp.head.script}" if="webhelp.head.script"></param>
      <param name="WEBHELP_SEARCH_SCRIPT" expression="${webhelp.google.search.script.url}" if="webhelp.google.search.script.url"></param>
      <param name="WEBHELP_BODY_SCRIPT" expression="${webhelp.body.script}" if="webhelp.body.script"></param>
      <param name="WEBHELP_PRODUCT_ID" expression="${webhelp.product.id}" if="webhelp.product.id"></param>
      <param name="WEBHELP_PRODUCT_VERSION" expression="${webhelp.product.version}" if="webhelp.product.version"></param>
      <param name="WEBHELP_VERSION" expression="${webhelp.version}" if="webhelp.version"></param>
      <param name="WEBHELP_BUILD_NUMBER" expression="${webhelp.build.number}" if="webhelp.build.number"></param>
      <param name="WEBHELP_UNIQUE_ID" expression="${gen.time}"></param>      
      <param name="INDEX_XML_FILEPATH" expression="${output.dir}/index.xml"></param>

      <param name="TOC_XML_FILEPATH" expression="${output.dir}/toc.xml"></param>
      <param name="WEBHELP_LOGO_IMAGE" expression="${webhelp.logo.image.output}" if="webhelp.logo.image.output"></param>
      <param name="WEBHELP_LOGO_IMAGE_TARGET_URL" expression="${webhelp.logo.image.target.url}" if="webhelp.logo.image.target.url"></param>
      <param name="show.changes.and.comments" expression="${webhelp.show.changes.and.comments}"></param>
      <!--
    
Oxygen WebHelp Plugin
Copyright (c) 1998-2017 Syncro Soft SRL, Romania.  All rights reserved.

-->
  <!--EXM-21177 Default language for HTML, automatically added by integrator-->
  
<param name="DEFAULTLANG" expression="${args.default.language}" if="args.default.language"></param>

    
<param name="com.oxygenxml.xhtml.linkToMediaResources" expression="${com.oxygenxml.xhtml.linkToMediaResources}" if="com.oxygenxml.xhtml.linkToMediaResources"></param>

      <!-- 
        Extension point to pass parameters to the XSLT transformation.
      -->
      
      <sysproperty key="DOT_VERSION" value="${otversion}"></sysproperty>
      <xmlcatalog refid="dita.catalog"></xmlcatalog>
    </xslt>
  </target>


  <!-- Customize table of contents. -->
  <target name="dita.out.map.webhelp.toc" depends="detectIndexerLang" description="Build WebHelp TOC file">
    <xslt processor="trax" basedir="${dita.temp.dir}" destdir="${output.dir}" includesfile="${dita.temp.dir}/${user.input.file.listfile}" classpathref="dost.class.path" style="${webhelp.classic.dir}/xsl/dita/map2xhtmtoc.xsl" force="yes" reloadstylesheet="${webhelp.reload.stylesheet}">
      <excludesfile name="${dita.temp.dir}/${resourceonlyfile}" if="resourceonlyfile"></excludesfile>
      <param name="DITAEXT" expression="${dita.ext}" if="dita.ext"></param>
      <param name="OUTEXT" expression="${out.ext}" if="out.ext"></param>
      <param name="BASEDIR" expression="${basedir}"></param>
      <param name="OUTPUTDIR" expression="${output.dir}"></param>
      <param name="LANGUAGE" expression="${args.default.language}" if="args.default.language"></param>
      <param name="DEFAULTLANG" expression="${args.default.language}" if="args.default.language"></param>
      <param name="TOC_FILE_NAME" expression="${args.xhtml.toc}${out.ext}" if="args.xhtml.toc"></param>
      <param name="contenttarget" expression="${args.xhtml.contenttarget}" if="args.xhtml.contenttarget"></param>
      <param name="CSS" expression="${args.css.file}" if="args.css.file"></param>
      <param name="CSSPATH" expression="${user.csspath}" if="user.csspath"></param>
      <param name="OUTPUTCLASS" expression="${args.xhtml.toc.class}" if="args.xhtml.toc.class"></param>
      <param name="WEBHELP_COPYRIGHT" expression="${webhelp.copyright}" if="webhelp.copyright"></param>
      <param name="INDEXER_LANGUAGE" expression="${webhelp.language}" if="webhelp.language"></param>
      <sysproperty key="DOT_VERSION" value="${otversion}"></sysproperty>
      <mergemapper to="${args.xhtml.toc}${out.ext}"></mergemapper>
      <xmlcatalog refid="dita.catalog"></xmlcatalog>
    </xslt>
  	
    <makeurl file="${dita.input.valfile}" property="dita.input.valfile.url" validate="no"></makeurl>
    
    <property name="args.createTocXML.xsl" value="${webhelp.classic.dir}/xsl/dita/tocDita.xsl"></property>    
    <xslt processor="trax" in="${dita.temp.dir}/${user.input.file}" out="${output.dir}/toc.xml" style="${args.createTocXML.xsl}" force="yes" classpathref="dost.class.path" reloadstylesheet="${webhelp.reload.stylesheet}">
      <param name="OUT_EXT" expression="${out.ext}"></param>
      <param name="FILTERFILE" expression="${dita.input.valfile.url}" if="dita.input.valfile"></param>
      
      <!-- 
        Extension point to pass parameters to the XSLT transformation that creates the 'toc.xml' file.
      -->
            
      
      <sysproperty key="DOT_VERSION" value="${otversion}"></sysproperty>
      <outputproperty name="method" value="xhtml"></outputproperty>
      <xmlcatalog refid="dita.catalog"></xmlcatalog>
    </xslt>
      
    <!-- Create context-help-map.xml -->
    <xslt processor="trax" in="${dita.temp.dir}/${user.input.file}" out="${output.dir}/context-help-map.xml" style="${webhelp.classic.dir}/xsl/dita/contextHelpMapDita.xsl" force="yes" classpathref="dost.class.path" reloadstylesheet="${webhelp.reload.stylesheet}">
          <param name="OUT_EXT" expression="${out.ext}"></param>
          <param name="WEBHELP_PRODUCT_ID" expression="${webhelp.product.id}" if="webhelp.product.id"></param>
          <param name="WEBHELP_PRODUCT_VERSION" expression="${webhelp.product.version}" if="webhelp.product.version"></param>
      <sysproperty key="DOT_VERSION" value="${otversion}"></sysproperty>
      <xmlcatalog refid="dita.catalog"></xmlcatalog>
    </xslt>
      
    <!-- Create context-help-map.js -->
    <xslt processor="trax" in="${output.dir}/context-help-map.xml" out="${output.dir}/context-help-map.js" style="${webhelp.classic.dir}/xsl/dita/contextHelpMapDitaJS.xsl" force="yes" classpathref="dost.class.path" reloadstylesheet="${webhelp.reload.stylesheet}">
      <xmlcatalog refid="dita.catalog"></xmlcatalog>
    </xslt>
      
    <loadfile property="file" srcfile="${dita.temp.dir}/${user.input.file}"></loadfile>
    <propertyregex property="mapfile.language" input="${file}" regexp="xml:lang=&quot;(.+?)&quot;" select="\1"></propertyregex>
    <condition property="webhelp.page.direction" value="rtl" else="ltr">
         <or>
             <equals arg1="ar" arg2="${mapfile.language}"></equals>
             <equals arg1="ar-eg" arg2="${mapfile.language}"></equals>
             <equals arg1="he" arg2="${mapfile.language}"></equals>
             <equals arg1="he-il" arg2="${mapfile.language}"></equals>
             <equals arg1="ur" arg2="${mapfile.language}"></equals>
             <equals arg1="ur-pk" arg2="${mapfile.language}"></equals>
         </or>
    </condition>
  </target>
    
  <target name="dita.webhelp.sitemap.xml" if="webhelp.sitemap.base.url">
      <tstamp>
          <format property="webhelp.sitemap.date" pattern="yyyy-MM-dd"></format>
      </tstamp>
      
      <xslt processor="trax" in="${dita.temp.dir}/${user.input.file}" out="${output.dir}/sitemap.xml" style="${webhelp.classic.dir}/xsl/dita/sitemapDita.xsl" force="yes" classpathref="dost.class.path" reloadstylesheet="${webhelp.reload.stylesheet}">
          <param name="OUT_EXT" expression="${out.ext}"></param>
          <param name="WEBHELP_BASE_URL" expression="${webhelp.sitemap.base.url}" if="webhelp.sitemap.base.url"></param>
          <param name="WEBHELP_LAST_MODIFIED" expression="${webhelp.sitemap.date}"></param>
          <param name="WEBHELP_CHANGE_FREQUENCY" expression="${webhelp.sitemap.change.frequency}" if="webhelp.sitemap.change.frequency"></param>
          <param name="WEBHELP_PRIORITY" expression="${webhelp.sitemap.priority}" if="webhelp.sitemap.priority"></param>
        <sysproperty key="DOT_VERSION" value="${otversion}"></sysproperty>
        <xmlcatalog refid="dita.catalog"></xmlcatalog>
      </xslt>
  </target>

  <!-- Target executed before indexing the HTML files -->
  <target name="webhelp-index-preprocess">
    <!-- Collect the topics marked with @search="no" in order to exclude them from search indexer -->
    <property name="create.search.excludes.xsl" value="${webhelp.classic.dir}/xsl/dita/createSearchExcludesFile.xsl"></property>
    <property name="search.excludes.file" value="${output.dir}/oxygen-webhelp/search/search-excludes.txt"></property>
    <xslt processor="trax" in="${dita.temp.dir}/${user.input.file}" out="${search.excludes.file}" style="${create.search.excludes.xsl}" force="yes" classpathref="dost.class.path" reloadstylesheet="${webhelp.reload.stylesheet}">
      
      <factory name="net.sf.saxon.TransformerFactoryImpl"></factory>
      <outputproperty name="method" value="text"></outputproperty>
      <outputproperty name="omit-xml-declaration" value="yes"></outputproperty>
      
      <param name="OUT_EXTENSION" expression="${args.outext}"></param>
      <xmlcatalog refid="dita.catalog"></xmlcatalog>
    </xslt>
    <available file="${search.excludes.file}" property="search.excludes.file.exists"></available>
  </target>
</project>